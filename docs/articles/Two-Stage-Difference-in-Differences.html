<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="did2s">
<title>Two-Stage Difference-in-Differences • did2s</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Two-Stage Difference-in-Differences">
<meta property="og:description" content="did2s">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">did2s</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Two-Stage-Difference-in-Differences.html">Two-Stage Difference-in-Differences</a>
    <a class="dropdown-item" href="../articles/event_study.html">So you're trying to choose an event-study estimator...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Two-Stage Difference-in-Differences</h1>
            
      
      
      <div class="d-none name"><code>Two-Stage-Difference-in-Differences.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="two-stage-difference-in-differences-gardner-2021">Two-stage Difference-in-differences, <a href="https://jrgcmu.github.io/2sdd_current.pdf" class="external-link">Gardner (2021)</a><a class="anchor" aria-label="anchor" href="#two-stage-difference-in-differences-gardner-2021"></a>
</h3>
<p>Researchers often want to a difference-in-differences (DiD) model in
a regression setting. Typically, these have made use of the so-called
<em>twoway fixed effects</em> (TWFE) framework. For example, in a static
setting:</p>
<p><span class="math display">\[\begin{equation}
  y_{it} = \mu_i + \mu_t + \tau D_{it} + \varepsilon_{it},
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\mu_i\)</span> are unit fixed
effects, <span class="math inline">\(\mu_t\)</span> are time fixed
effects, and <span class="math inline">\(D_{it}\)</span> is an indicator
for receiving treatment.</p>
<p>Similarly, a (dynamic) event-study TWFE model could be written
as:</p>
<p><span class="math display">\[\begin{equation}
y_{it} = \mu_i + \mu_t + \sum_{k = -L}^{-2} \tau^k D_{it}^k + \sum_{k =
1}^{K} \tau^k D_{it}^k + \varepsilon_{it},
\end{equation}\]</span></p>
<p>where <span class="math inline">\(D_{it}^k\)</span> are lag/leads of
treatment (k periods from initial treatment date).</p>
<aside>
Aside: Sometimes researches use variants of this model where they bin or
drop leads and lags.
</aside><p>However, running OLS to estimate either model has been shown to not
recover an average treatment effect and has the potential to be severely
misleading in cases of treatment effect heterogeneity <a href="https://www.dropbox.com/s/y92mmyndlbkufo1/Draft_RobustAndEfficient.pdf?raw=true" class="external-link">Borusyak
et. al. (2021)</a>; <a href="https://www.sciencedirect.com/science/article/pii/S0304407621001445#b18" class="external-link">Callaway
and Sant’Anna (2020)</a>; <a href="https://doi.org/10.1257/aer.20181169" class="external-link">de Chaisemartin and
d’Haultfoeuille (2020)</a>; <a href="https://www.sciencedirect.com/science/article/pii/S0304407621001445" class="external-link">Goodman-Bacon
(2021)</a>; <a href="https://www.sciencedirect.com/science/article/pii/S030440762030378X" class="external-link">Sun
and Abraham (2020)</a>].</p>
<p>One way of thinking about this problem is through the <a href="https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem" class="external-link">Frisch–Waugh–Lovell
(FWL) theorem</a>. When estimating the unit and time fixed effects, you
create a residualized <span class="math inline">\(\tilde{Y}_{it}\)</span> which is commonly said to
be “the outcome variable after removing time shocks and fixed units
characteristics”, but you also create a residulaized <span class="math inline">\(\tilde{D}_{it}\)</span> or <span class="math inline">\(\tilde{D}_{it}^k\)</span>. To simplify the
literature, this residualized treatment indicators is what creates the
problem of interpreting <span class="math inline">\(\tau\)</span> or
<span class="math inline">\(\tau^k\)</span>, especially when treatment
effects are heterogeneous.</p>
<p>That’s where <a href="https://jrgcmu.github.io/2sdd_current.pdf" class="external-link">Gardner (2021)</a>
comes in. What Gardner does to fix the problem is quite simple: estimate
<span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\mu_t\)</span> seperately so you don’t residualize
the treatment indicators. In the absence of treatment, the TWFE model
gives you a model for (potentially unobserved) untreated outcomes</p>
<p><span class="math display">\[y_{it}(0) = \mu_i + \mu_t +
\varepsilon_{it}.\]</span></p>
<p>Therefore, if you can <strong><em>consistently</em></strong> estimate
<span class="math inline">\(y_{it}(0)\)</span>, you can impute the
untreated outcome and remove that from the observed outcome <span class="math inline">\(y_{it}\)</span>. The value of <span class="math inline">\(y_{it} - \hat{y}_{it}(0)\)</span> should be close
to zero for control units and should be close to <span class="math inline">\(\tau_{it}\)</span> for treated observations. Then,
regressing <span class="math inline">\(y_{it} - \hat{y}_{it}(0)\)</span>
on the treatment variables should give unbiased estimates of treatment
effects (either static or dynamic/event-study).</p>
<aside>
Aside: This is the same logic as the new paper by [<a href="https://sites.google.com/view/borusyak/research" class="external-link">Borusyak et.
al. (2021)</a>.
</aside><p>The steps of the two-step estimator are:</p>
<ol style="list-style-type: decimal">
<li><p>First estimate <span class="math inline">\(\mu_i\)</span> and
<span class="math inline">\(\mu_t\)</span> using
untreated/not-yet-treated observations, i.e. the subsample with <span class="math inline">\(D_{it}=0\)</span>. Residualize outcomes <span class="math inline">\(\tilde{y}_{it} = y_{it} - \hat{\mu}_i -
\hat{\mu}_t\)</span>.</p></li>
<li><p>Regress <span class="math inline">\(\tilde{y}_{it}\)</span> on
<span class="math inline">\(D_{it}\)</span> or <span class="math inline">\(D_{it}^k\)</span>’s to estimate the treatment
effect <span class="math inline">\(\tau\)</span> or <span class="math inline">\(\tau^k\)</span>’s.</p></li>
</ol>
<p>Some notes:</p>
<div class="section level4">
<h4 id="standard-errors">Standard Errors<a class="anchor" aria-label="anchor" href="#standard-errors"></a>
</h4>
<p>First, the standard errors on <span class="math inline">\(\tau\)</span> or <span class="math inline">\(\tau^k\)</span>’s will be incorrect as the
dependent variable is itself an estimate. This is referred to the
generated regressor problem in econometrics parlance. Therefore, <a href="https://jrgcmu.github.io/2sdd_current.pdf" class="external-link">Gardner (2021)</a> has
developed a GMM estimator that will give asymptotically correct standard
errors.</p>
<aside>
Details are left to the paper, but are implemented in this R package
</aside>
</div>
<div class="section level4">
<h4 id="anticipation">Anticipation<a class="anchor" aria-label="anchor" href="#anticipation"></a>
</h4>
<p>Second, this procedure works so long as <span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\mu_t\)</span> are
<strong><em>consistently</em></strong> estimated. The key is to use only
untreated/not-yet-treated observations to estimate the fixed effects.
For example, if you used observations with <span class="math inline">\(D_{it} = 1\)</span>, you would attribute treatment
effects <span class="math inline">\(\tau\)</span> as “fixed
characteristics” and would combine <span class="math inline">\(\mu_i\)</span> with the treatment effects.</p>
<p>The fixed effects could be biased/inconsistent if there are
anticipation effects, i.e. units respond before treatment starts. The
fix is fairly simple, simply “shift” treatment date earlier by as many
years as you suspect anticipation to occur (e.g. 2 years before
treatment starts) and estimate on the subsample where the shifted
treatment equals zero.</p>
<aside>
This R package allows you to specify the variable <span class="math inline">\(D_{it}\)</span>, if you suspect anticipation,
provide the shifted variable to this option.
</aside>
</div>
<div class="section level4">
<h4 id="covariates">Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h4>
<p>This method works with pre-determined covariates as well. Augment the
above step 1. to include <span class="math inline">\(X_i\)</span> and
remove that from <span class="math inline">\(y_{it}\)</span> along with
the fixed effects to get <span class="math inline">\(\tilde{y}_{it}\)</span>.</p>
</div>
</div>
<div class="section level3">
<h3 id="did2s-r-package">did2s R Package<a class="anchor" aria-label="anchor" href="#did2s-r-package"></a>
</h3>
<p><strong>did2s</strong> is an R package that implements the two-stage
DiD procedure described above. To install the package, run the
following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"kylebutts/did2s"</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Note: Windows users should install <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a> before
running the above command, since they will need to compile some C++ code
from source.</p>
</blockquote>
<p>The main function is <strong><code><a href="../reference/did2s.html">did2s()</a></code></strong>, which
estimates the two-stage DiD procedure. The function is really a
convenience wrapper (plus some important transformations) around <a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link"><code>fixest::feols()</code></a>
and will return a <strong>fixest</strong> object. This is important for
several reasons that will become clear in the examples that follow.</p>
<p><strong><code><a href="../reference/did2s.html">did2s()</a></code></strong> requires the following
arguments:</p>
<ul>
<li>
<code>yname</code>: The outcome variable. For example,
<code>"y"</code>.</li>
<li>
<code>first_stage</code>: Formula indicating the first stage. This
can include fixed effects and covariates, but do not include treatment
variable(s)! For efficiency, it is recommended to use the
<strong>fixest</strong> convention of specifying fixed effects after a
vertical bar. For example, <code>~ x1 + x2 | fe1 + fe2</code>.</li>
<li>
<code>second_stage</code>: Formula indicating the treatment variable
or, in the case of event studies, treatment variables. Again, following
<strong>fixest</strong> conventions, it is recommended to use the <a href="https://lrberge.github.io/fixest/reference/i.html" class="external-link"><code>i()</code></a>
syntax. For example, <code>~ i(time_to_treatment, ref = 0)</code>.</li>
<li>
<code>treatment</code>: A binary (1/0) or logical (TRUE/FALSE)
variable demarcating when treatment turns on for a unit. For example,
<code>"treated"</code>.</li>
</ul>
<p>Optional arguments include the ability to implement weighted
regressions and whether to cluster or bootstrap standard errors.</p>
<div class="section level4">
<h4 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<p>Let’s walk through an example dataset from the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://kylebutts.com/did2s/">did2s</a></span><span class="op">)</span> <span class="co">## The main package. Will automatically load fixest as well.</span></span>
<span><span class="co">#&gt; Loading required package: fixest</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> did2s (v0.7.0). For more information on the methodology, visit <span style="color: #0000BB; font-style: italic;">&lt;https://www.kylebutts.com/did2s&gt;</span></span></span>
<span><span class="co">#&gt; To cite did2s in publications use:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Butts, Kyle (2021).  did2s: Two-Stage Difference-in-Differences</span></span>
<span><span class="co">#&gt;   Following Gardner (2021). R package version 0.7.0.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   @Manual{,</span></span>
<span><span class="co">#&gt;     title = {did2s: Two-Stage Difference-in-Differences Following Gardner (2021)},</span></span>
<span><span class="co">#&gt;     author = {Kyle Butts},</span></span>
<span><span class="co">#&gt;     year = {2021},</span></span>
<span><span class="co">#&gt;     url = {https://github.com/kylebutts/did2s/},</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Load heterogeneous treatment dataset from the package</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"df_het"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_het</span><span class="op">)</span></span>
<span><span class="co">#&gt;     unit state   group  unit_fe     g  year     year_fe  treat rel_year</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;int&gt;  &lt;char&gt;    &lt;num&gt; &lt;num&gt; &lt;int&gt;       &lt;num&gt; &lt;lgcl&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1    33 Group 2 7.043016  2010  1990  0.06615889  FALSE      -20</span></span>
<span><span class="co">#&gt; 2:     1    33 Group 2 7.043016  2010  1991 -0.03098032  FALSE      -19</span></span>
<span><span class="co">#&gt; 3:     1    33 Group 2 7.043016  2010  1992 -0.11960742  FALSE      -18</span></span>
<span><span class="co">#&gt; 4:     1    33 Group 2 7.043016  2010  1993  0.12632146  FALSE      -17</span></span>
<span><span class="co">#&gt; 5:     1    33 Group 2 7.043016  2010  1994 -0.10692055  FALSE      -16</span></span>
<span><span class="co">#&gt; 6:     1    33 Group 2 7.043016  2010  1995 -0.27042020  FALSE      -15</span></span>
<span><span class="co">#&gt;    rel_year_binned       error    te te_dynamic  dep_var</span></span>
<span><span class="co">#&gt;              &lt;num&gt;       &lt;num&gt; &lt;num&gt;      &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:              -6 -0.08646599     0          0 7.022709</span></span>
<span><span class="co">#&gt; 2:              -6  0.76659269     0          0 7.778628</span></span>
<span><span class="co">#&gt; 3:              -6  1.51296819     0          0 8.436377</span></span>
<span><span class="co">#&gt; 4:              -6  0.02186978     0          0 7.191207</span></span>
<span><span class="co">#&gt; 5:              -6 -0.01760317     0          0 6.918492</span></span>
<span><span class="co">#&gt; 6:              -6  2.19452731     0          0 8.967123</span></span></code></pre></div>
<p>Here is a plot of the average outcome variable for each of the
groups:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Mean for treatment group-year</span></span>
<span><span class="va">agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">df_het</span><span class="op">$</span><span class="va">dep_var</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>g <span class="op">=</span> <span class="va">df_het</span><span class="op">$</span><span class="va">g</span>, year <span class="op">=</span> <span class="va">df_het</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">==</span> <span class="st">"0"</span>, <span class="st">"Never Treated"</span>, <span class="va">agg</span><span class="op">$</span><span class="va">g</span><span class="op">)</span></span>
<span></span>
<span><span class="va">never</span> <span class="op">&lt;-</span> <span class="va">agg</span><span class="op">[</span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">==</span> <span class="st">"Never Treated"</span>, <span class="op">]</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="va">agg</span><span class="op">[</span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">==</span> <span class="st">"2000"</span>, <span class="op">]</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="va">agg</span><span class="op">[</span><span class="va">agg</span><span class="op">$</span><span class="va">g</span> <span class="op">==</span> <span class="st">"2010"</span>, <span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1990</span>,<span class="fl">2020</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">7.2</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Data-generating Process"</span>, ylab <span class="op">=</span> <span class="st">"Outcome"</span>, xlab <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1999.5</span>, <span class="fl">2009.5</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">never</span><span class="op">$</span><span class="va">year</span>, <span class="va">never</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">"#8e549f"</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">g1</span><span class="op">$</span><span class="va">year</span>, <span class="va">g1</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">"#497eb3"</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">g2</span><span class="op">$</span><span class="va">year</span>, <span class="va">g2</span><span class="op">$</span><span class="va">x</span>, col <span class="op">=</span> <span class="st">"#d2382c"</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">1990</span>, y<span class="op">=</span><span class="fl">7.1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#8e549f"</span>, <span class="st">"#497eb3"</span>, <span class="st">"#d2382c"</span><span class="op">)</span>, </span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">17</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Never Treated"</span>, <span class="st">"2000"</span>, <span class="st">"2010"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Two-Stage-Difference-in-Differences_files/figure-html/plot-df-het-1.png" alt="Example data with heterogeneous treatment effects" width="768"><p class="caption">
Example data with heterogeneous treatment effects
</p>
</div>
</div>
<div class="section level4">
<h4 id="estimate-two-stage-difference-in-differences">Estimate Two-stage Difference-in-Differences<a class="anchor" aria-label="anchor" href="#estimate-two-stage-difference-in-differences"></a>
</h4>
<p>First, lets estimate a static did. There are two things to note here.
First, note that I can use <code><a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link">fixest::feols</a></code> formula including
the <code>|</code> for specifying fixed effects and
<code><a href="https://lrberge.github.io/fixest/reference/i.html" class="external-link">fixest::i</a></code> for improved factor variable support. Second,
note that <code>did2s</code> returns a <code>fixest</code> estimate
object, so <code><a href="https://lrberge.github.io/fixest/reference/etable.html" class="external-link">fixest::esttable</a></code>, <code><a href="https://lrberge.github.io/fixest/reference/coefplot.html" class="external-link">fixest::coefplot</a></code>,
and <code><a href="https://lrberge.github.io/fixest/reference/coefplot.html" class="external-link">fixest::iplot</a></code> all work as expected.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Static</span></span>
<span><span class="va">static</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/did2s.html">did2s</a></span><span class="op">(</span><span class="va">df_het</span>, </span>
<span>                yname <span class="op">=</span> <span class="st">"dep_var"</span>, first_stage <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">state</span> <span class="op">+</span> <span class="va">year</span>, </span>
<span>                second_stage <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html" class="external-link">i</a></span><span class="op">(</span><span class="va">treat</span>, ref<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>, treatment <span class="op">=</span> <span class="st">"treat"</span>, </span>
<span>                cluster_var <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running Two-stage Difference-in-Differences</span></span>
<span><span class="co">#&gt; • first stage formula `~ 0 | state + year`</span></span>
<span><span class="co">#&gt; • second stage formula `~ i(treat, ref = FALSE)`</span></span>
<span><span class="co">#&gt; • The indicator variable that denotes when treatment is on is `treat`</span></span>
<span><span class="co">#&gt; • Standard errors will be clustered by `state`</span></span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/etable.html" class="external-link">esttable</a></span><span class="op">(</span><span class="va">static</span><span class="op">)</span></span>
<span><span class="co">#&gt;                            static</span></span>
<span><span class="co">#&gt; Dependent Var.:           dep_var</span></span>
<span><span class="co">#&gt;                                  </span></span>
<span><span class="co">#&gt; treat = TRUE    2.152*** (0.0476)</span></span>
<span><span class="co">#&gt; _______________ _________________</span></span>
<span><span class="co">#&gt; S.E. type                  Custom</span></span>
<span><span class="co">#&gt; Observations               46,500</span></span>
<span><span class="co">#&gt; R2                        0.33790</span></span>
<span><span class="co">#&gt; Adj. R2                   0.33790</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>This is very close to the true treatment effect of ~2.23.</p>
<p>Then, let’s estimate an event study did. Note that relative year has
a value of <code>Inf</code> for never treated, so I put this as a
reference in the second stage formula.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Event Study</span></span>
<span><span class="va">es</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/did2s.html">did2s</a></span><span class="op">(</span><span class="va">df_het</span>,</span>
<span>            yname <span class="op">=</span> <span class="st">"dep_var"</span>, first_stage <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">state</span> <span class="op">+</span> <span class="va">year</span>, </span>
<span>            second_stage <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html" class="external-link">i</a></span><span class="op">(</span><span class="va">rel_year</span>, ref<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>, treatment <span class="op">=</span> <span class="st">"treat"</span>, </span>
<span>            cluster_var <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running Two-stage Difference-in-Differences</span></span>
<span><span class="co">#&gt; • first stage formula `~ 0 | state + year`</span></span>
<span><span class="co">#&gt; • second stage formula `~ i(rel_year, ref = c(-1, Inf))`</span></span>
<span><span class="co">#&gt; • The indicator variable that denotes when treatment is on is `treat`</span></span>
<span><span class="co">#&gt; • Standard errors will be clustered by `state`</span></span></code></pre></div>
<p>And plot the results:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html" class="external-link">iplot</a></span><span class="op">(</span><span class="va">es</span>, main <span class="op">=</span> <span class="st">"Event study: Staggered treatment"</span>, xlab <span class="op">=</span> <span class="st">"Relative time to treatment"</span>, col <span class="op">=</span> <span class="st">"steelblue"</span>, ref.line <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the (mean) true effects</span></span>
<span><span class="va">true_effects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="op">(</span><span class="va">df_het</span><span class="op">$</span><span class="va">te</span> <span class="op">+</span> <span class="va">df_het</span><span class="op">$</span><span class="va">te_dynamic</span><span class="op">)</span>, <span class="va">df_het</span><span class="op">$</span><span class="va">rel_year</span>, <span class="va">mean</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span><span class="op">:</span><span class="fl">20</span>, <span class="va">true_effects</span>, pch <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Legend</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="fl">20</span>, y<span class="op">=</span><span class="fl">3</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"steelblue"</span>, <span class="st">"black"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Two-stage estimate"</span>, <span class="st">"True effect"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Two-Stage-Difference-in-Differences_files/figure-html/plot-es-1.png" alt="Event-study plot with example data" width="700"><p class="caption">
Event-study plot with example data
</p>
</div>
</div>
<div class="section level4">
<h4 id="comparison-to-twfe">Comparison to TWFE<a class="anchor" aria-label="anchor" href="#comparison-to-twfe"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">twfe</span> <span class="op">=</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link">feols</a></span><span class="op">(</span><span class="va">dep_var</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html" class="external-link">i</a></span><span class="op">(</span><span class="va">rel_year</span>, ref<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">unit</span> <span class="op">+</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">df_het</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">fixest</span><span class="fu">::</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html" class="external-link">iplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">es</span>, <span class="va">twfe</span><span class="op">)</span>, sep <span class="op">=</span> <span class="fl">0.2</span>, ref.line <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>,</span>
<span>      col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"steelblue"</span>, <span class="st">"#82b446"</span><span class="op">)</span>, pt.pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">18</span><span class="op">)</span>, </span>
<span>      xlab <span class="op">=</span> <span class="st">"Relative time to treatment"</span>, </span>
<span>      main <span class="op">=</span> <span class="st">"Event study: Staggered treatment (comparison)"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Legend</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">-</span><span class="fl">20</span>, y<span class="op">=</span><span class="fl">3</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"steelblue"</span>, <span class="st">"#82b446"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">18</span><span class="op">)</span>, </span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Two-stage estimate"</span>, <span class="st">"TWFE"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Two-Stage-Difference-in-Differences_files/figure-html/plot-compare-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<p>If you use this package to produce scientific or commercial
publications, please cite according to:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"did2s"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; To cite did2s in publications use:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Butts, Kyle (2021).  did2s: Two-Stage Difference-in-Differences</span></span>
<span><span class="co">#&gt;   Following Gardner (2021). R package version 0.7.0.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   @Manual{,</span></span>
<span><span class="co">#&gt;     title = {did2s: Two-Stage Difference-in-Differences Following Gardner (2021)},</span></span>
<span><span class="co">#&gt;     author = {Kyle Butts},</span></span>
<span><span class="co">#&gt;     year = {2021},</span></span>
<span><span class="co">#&gt;     url = {https://github.com/kylebutts/did2s/},</span></span>
<span><span class="co">#&gt;   }</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p>Borusyak, Kirill, Xavier Jaravel, and Jann Spiess (2021). <a href="https://www.dropbox.com/s/y92mmyndlbkufo1/Draft_RobustAndEfficient.pdf?raw=true" class="external-link">“Revisiting
Event Study Designs: Robust and Efficient Estimation”</a>, Working
Paper.</p></li>
<li><p>Callaway, Brantly, and Pedro H. C. Sant’Anna (2020). <a href="https://www.sciencedirect.com/science/article/pii/S0304407621001445#b18" class="external-link">“Difference-in-differences
with multiple time periods.”</a>, <em>Journal of
Econometrics</em>.</p></li>
<li><p>de Chaisemartin, Clement, and Xavier d’Haultfoeuille (2020). <a href="https://doi.org/10.1257/aer.20181169" class="external-link">“Two-way fixed effects
estimators with heterogeneous treatment effects.”</a>, <em>American
Economic Review</em>.</p></li>
<li><p>Gardner, John (2021). <a href="https://jrgcmu.github.io/2sdd_current.pdf" class="external-link">“Two-Stage
Difference-in-Differences.”</a>, Working Paper.</p></li>
<li><p>Goodman-Bacon, Andrew (2021). <a href="https://www.sciencedirect.com/science/article/pii/S0304407621001445" class="external-link">“Difference-in-differences
with variation in treatment timing.”</a>, <em>Journal of
Econometrics</em>.</p></li>
<li><p>Sun, Liyang, and Sarah Abraham (2020). <a href="https://www.sciencedirect.com/science/article/pii/S030440762030378X" class="external-link">“Estimating
dynamic treatment effects in event studies with heterogeneous treatment
effects.”</a>, <em>Journal of Econometrics</em>.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kyle Butts, John Gardner.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
